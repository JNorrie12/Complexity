# Complexity Project 1/17 - 2/17
import numpy as np
import random as rd
import matplotlib.pyplot as plt


L = 32   #Length of domain
p = 0.5  #Porbability of threshold
t = 100#Number of sand grains dropped

class oslo():
    def __init__(self, L):
        self.size = L
        self.height = np.zeros(L + 1)
        self.thresh = np.array([rd.randint(1, 2) for x in self.height])

    def draw(self):
        for i in range(L):
            print '[{}, {}, {}]'.format(int(self.height[i]),int(self.thresh[i]),int(self.height[i])-int(self.height[i+1])) + '#'* np.int(self.height[i])

    def drive(self):
        # add rice grain to lefthand side
        self.height[0] += 1

    def relax(self):
        # move through each element of heights
        # compute slope
        shift = np.roll(self.height, -1)
        shift[-1] = 0
        slope = self.height - shift
        truefalse = (slope) > self.thresh #When slope>thresh = 1
        s=0
        while np.sum(truefalse) > 0 :
            for i in np.arange(L):
                if truefalse[i] == 1 :
                    if i==L-1 :
                        self.height[L-1] -= 1
                    else:
                        self.height[i] -= 1
                        self.height[i+1] += 1
                    s +=1
                self.thresh[i] = np.random.binomial(1, p, None) + 1.5
                shift = np.roll(self.height, -1)
                shift[-1] = 0
                slope = self.height - shift
                truefalse = (slope) > self.thresh  #Used to update truefalse, better way to do this?
        print s

pile = oslo(L)  #creating objects
while True:
    pile.drive()
    pile.relax()
    pile.draw()
    t += 1
    quitcon=raw_input()
    print t
    if quitcon == "q":
        quit()
